<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∏—Å—Ç–µ–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2980b9;
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --background-color: #f8f9fa;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --general-registration-color: #9b59b6;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 30px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    .card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .registration-type {
      margin-bottom: 20px;
    }

    .registration-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .registration-option {
      flex: 1;
      min-width: 120px;
      padding: 15px 10px;
      background-color: var(--card-background);
      border: 2px solid var(--border-color);
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }

    .registration-option.general-reg {
      background-color: var(--general-registration-color);
      color: white;
    }

    .registration-option.general-reg.active {
      background-color: #8e44ad;
      box-shadow: 0 0 10px rgba(142, 68, 173, 0.5);
    }

    .registration-option.hall-reg {
      background-color: var(--primary-color);
      color: white;
    }

    .registration-option.hall-reg.active {
      background-color: var(--secondary-color);
      box-shadow: 0 0 10px rgba(41, 128, 185, 0.5);
    }

    .hall-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      transition: opacity 0.3s ease;
    }

    .hall-selector.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .hall-button {
      flex: 1;
      min-width: 80px;
      padding: 10px;
      background-color: var(--card-background);
      border: 2px solid var(--border-color);
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }

    .hall-button.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--secondary-color);
    }

    #reader {
      width: 100%;
      overflow: hidden;
      border-radius: 8px;
      margin: 20px 0;
    }

    #scan-button {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    #scan-button.general {
      background-color: var(--general-registration-color);
    }

    #scan-button.general:hover {
      background-color: #8e44ad;
    }

    #scan-button:hover {
      background-color: var(--secondary-color);
    }

    #scan-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #result {
      margin-top: 20px;
    }

    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      font-weight: bold;
    }

    .success {
      background-color: rgba(46, 204, 113, 0.2);
      color: #27ae60;
      border-left: 4px solid #27ae60;
    }

    .error {
      background-color: rgba(231, 76, 60, 0.2);
      color: #c0392b;
      border-left: 4px solid #c0392b;
    }

    #debug-info {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      width: 100%;
      background-color: #f9f9f9;
      white-space: pre-wrap;
      font-family: monospace;
      display: none;
      font-size: 14px;
      line-height: 1.5;
    }

    .current-mode-display {
      font-size: 18px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .general-registration-mode {
      color: var(--general-registration-color);
    }

    @media (max-width: 600px) {
      .hall-selector {
        flex-direction: row;
      }
      
      .hall-button {
        flex: 0 0 calc(20% - 10px);
      }
      
      .registration-options {
        flex-direction: column;
      }
      
      .registration-option {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>–°–∏—Å—Ç–µ–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</h1>
  </header>

  <div class="container">
    <div class="card registration-type">
      <h2>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</h2>
      <div class="registration-options">
        <div class="registration-option general-reg" id="general-registration">–ó–∞–≥–∞–ª—å–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
        <div class="registration-option hall-reg" id="hall-registration">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É –∑–∞–ª—ñ</div>
      </div>
      <div class="current-mode-display" id="current-mode">
        –û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
      </div>
    </div>

    <div class="card" id="hall-selection-card">
      <h2>–û–±–µ—Ä—ñ—Ç—å –∑–∞–ª</h2>
      <div class="hall-selector" id="hall-selector">
        <div class="hall-button" data-hall="1">–ó–∞–ª 1</div>
        <div class="hall-button" data-hall="2">–ó–∞–ª 2</div>
        <div class="hall-button" data-hall="3">–ó–∞–ª 3</div>
        <div class="hall-button" data-hall="4">–ó–∞–ª 4</div>
        <div class="hall-button" data-hall="5">–ó–∞–ª 5</div>
      </div>
      <div class="current-hall-display">–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª: <span id="current-hall">–Ω–µ –æ–±—Ä–∞–Ω–æ</span></div>
    </div>

    <div class="card">
      <h2>–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è QR-–∫–æ–¥—É</h2>
      <button id="scan-button" disabled>–ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</button>
      <div id="reader"></div>
      <div id="result"></div>
    </div>

    <div id="debug-info"></div>
  </div>
  
  <script>
window.addEventListener("load", () => {
  const SUPABASE_URL = 'https://jkvogvnbedjptqnhhehs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imprdm9ndm5iZWRqcHRxbmhoZWhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA0ODc1NjQsImV4cCI6MjA1NjA2MzU2NH0.6eqFSmqvZ2qL-9ZG6GE9A4_ALnIVsRKCvtMuObfv2n8';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const scanButton = document.getElementById("scan-button");
  const resultDiv = document.getElementById("result");
  const debugInfoDiv = document.getElementById("debug-info");
  const currentHallSpan = document.getElementById("current-hall");
  const hallButtons = document.querySelectorAll(".hall-button");
  const generalRegistrationBtn = document.getElementById("general-registration");
  const hallRegistrationBtn = document.getElementById("hall-registration");
  const currentModeDisplay = document.getElementById("current-mode");
  const hallSelectionCard = document.getElementById("hall-selection-card");
  const hallSelector = document.getElementById("hall-selector");
  
  let selectedHall = null;
  let registrationMode = null; // 'general' –∏–ª–∏ 'hall'
  let html5QrCode;
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–ª–∞
  function updateURL(mode, hall) {
    const params = new URLSearchParams();
    
    if (mode) {
      params.set('mode', mode);
      
      if (mode === 'hall' && hall) {
        params.set('hall', hall);
      }
    }
    
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    history.pushState({mode: mode, hall: hall}, '', newUrl);
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –∏ –∑–∞–ª–∞ –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  function initFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const modeParam = urlParams.get('mode');
    const hallParam = urlParams.get('hall');
    
    if (modeParam === 'general') {
      setRegistrationMode('general');
    } else if (modeParam === 'hall') {
      setRegistrationMode('hall');
      
      if (hallParam && ['1', '2', '3', '4', '5'].includes(hallParam)) {
        selectHall(hallParam);
      }
    }
  }
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  function setRegistrationMode(mode) {
    registrationMode = mode;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞
    if (mode === 'general') {
      generalRegistrationBtn.classList.add('active');
      hallRegistrationBtn.classList.remove('active');
      currentModeDisplay.textContent = '–†–µ–∂–∏–º –∑–∞–≥–∞–ª—å–Ω–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó';
      currentModeDisplay.classList.add('general-registration-mode');
      hallSelectionCard.style.display = 'none';
      scanButton.classList.add('general');
      scanButton.disabled = false;
    } else if (mode === 'hall') {
      generalRegistrationBtn.classList.remove('active');
      hallRegistrationBtn.classList.add('active');
      currentModeDisplay.textContent = '–†–µ–∂–∏–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —É –∑–∞–ª—ñ';
      currentModeDisplay.classList.remove('general-registration-mode');
      hallSelectionCard.style.display = 'block';
      scanButton.classList.remove('general');
      scanButton.disabled = !selectedHall;
    } else {
      generalRegistrationBtn.classList.remove('active');
      hallRegistrationBtn.classList.remove('active');
      currentModeDisplay.textContent = '–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó';
      currentModeDisplay.classList.remove('general-registration-mode');
      hallSelectionCard.style.display = 'none';
      scanButton.classList.remove('general');
      scanButton.disabled = true;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL
    updateURL(mode, selectedHall);
  }
  
  // –í—ã–±–æ—Ä –∑–∞–ª–∞
  function selectHall(hall) {
    selectedHall = hall;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –∑–∞–ª–æ–≤
    hallButtons.forEach(btn => {
      if (btn.dataset.hall === hall) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    currentHallSpan.textContent = hall ? `–ó–∞–ª ${hall}` : '–Ω–µ –æ–±—Ä–∞–Ω–æ';
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∑–∞–ª –∏ —Ä–µ–∂–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –∑–∞–ª–µ
    if (registrationMode === 'hall') {
      scanButton.disabled = !hall;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL
    updateURL(registrationMode, hall);
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
  generalRegistrationBtn.addEventListener('click', () => {
    setRegistrationMode('general');
  });
  
  hallRegistrationBtn.addEventListener('click', () => {
    setRegistrationMode('hall');
  });
  
  // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∑–∞–ª–∞
  hallButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectHall(btn.dataset.hall);
    });
  });
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ QR –∫–æ–¥–∞
  function parseQRData(qrData) {
    const parts = qrData.split(',');
    
    if (parts.length < 1) {
      throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥—É. –û—á—ñ–∫—É—î—Ç—å—Å—è: '–Ü–º'—è–ü—Ä—ñ–∑–≤–∏—â–µ,–ù–æ–º–µ—Ä–∏–ó–∞–ª—ñ–≤'");
    }
    
    const fullName = parts[0].trim();
    const hallNumbers = parts.length > 1 ? parts[1].trim().split('') : [];
    
    return { fullName, hallNumbers };
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  function displayDebugInfo(info) {
    debugInfoDiv.style.display = "block";
    
    let debugText = "=== –û–¢–õ–ê–î–û–ß–ù–ê –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø ===\n\n";
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∂–∏–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    debugText += `üìã –†–ï–ñ–ò–ú –†–ï–Ñ–°–¢–†–ê–¶–Ü–á: ${info.mode === 'general' ? '–ó–∞–≥–∞–ª—å–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è' : '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É –∑–∞–ª—ñ'}\n\n`;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    debugText += "üìã –î–ê–ù–Ü –Ü–ó QR-–ö–û–î–£:\n";
    debugText += `üë§ –Ü–º—è –ü—Ä—ñ–∑–≤–∏—â–µ: ${info.parsedData.fullName}\n`;
    debugText += `üè¢ –ù–æ–º–µ—Ä–∞ –∑–∞–ª—ñ–≤: ${info.parsedData.hallNumbers.length > 0 ? info.parsedData.hallNumbers.join(', ') : '–Ω–µ –≤–∫–∞–∑–∞–Ω—ñ'}\n\n`;
    
    if (info.mode === 'hall') {
      debugText += `üèõÔ∏è –û–±—Ä–∞–Ω–∏–π –∑–∞–ª: ${selectedHall}\n\n`;
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏
    debugText += `‚è±Ô∏è –ß–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è: ${new Date(info.timestamp).toLocaleString()}\n\n`;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –ë–î
    debugText += "üíæ –û–ü–ï–†–ê–¶–Ü–á –ó –ë–î:\n";
    info.dbOperations.forEach((op, index) => {
      debugText += `${index + 1}. ${op.description}\n`;
      if (op.table) {
        debugText += `   –¢–∞–±–ª–∏—Ü—è: ${op.table}\n`;
      }
      if (op.operation) {
        debugText += `   –û–ø–µ—Ä–∞—Ü—ñ—è: ${op.operation}\n`;
      }
      if (op.data) {
        debugText += `   –î–∞–Ω—ñ: ${JSON.stringify(op.data)}\n`;
      }
      if (op.response) {
        debugText += `   –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${JSON.stringify(op.response)}\n`;
      }
    });
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (info.error) {
      debugText += `\n‚ùå –ü–û–ú–ò–õ–ö–ê: ${info.error}\n`;
    } else {
      debugText += "\n‚úÖ –û–ø–µ—Ä–∞—Ü—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!\n";
    }
    
    debugInfoDiv.textContent = debugText;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ
  function showStatusMessage(message, isSuccess = true) {
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${isSuccess ? 'success' : 'error'}`;
    statusDiv.textContent = message;
    
    resultDiv.appendChild(statusDiv);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      statusDiv.remove();
    }, 5000);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü–µ
  async function checkUserExists(fullName) {
    const { data, error } = await supabase
      .from('all_visitors')
      .select('id, full_name, registration_time, hall_numbers')
      .eq('full_name', fullName)
      .single();
    
    return { exists: !!data, data, error };
  }
  
  function isHallAllowed(hallNumbersString, hallNumber) {
    // If no halls specified (empty string), all halls are allowed
    if (!hallNumbersString || hallNumbersString.trim() === '') {
      return true;
    }
    
    // Check if the hall is in the user's allowed halls
    const hallNumbers = hallNumbersString.split(/,\s*/);
    return hallNumbers.includes(hallNumber.toString());
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ª–∞
  async function checkHallVisit(userId, hall) {
    const { data, error } = await supabase
      .from(`hall_${hall}`)
      .select('id, full_name, visit_timestamps')
      .eq('id', userId)
      .single();
    
    return { exists: !!data, data, error };
  }
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü–µ
  async function registerNewUser(fullName, hallNumbers) {
    // Generate a consistent UUID for the user
    const userId = crypto.randomUUID();
    const timestamp = new Date().toISOString();
    
    // If no halls specified, allow all halls (1-5)
    const hallNumbersToUse = hallNumbers.length > 0 ? hallNumbers : ['1', '2', '3', '4', '5'];
    const hallNumbersString = hallNumbersToUse.join(", ");
    
    const dbOperations = [];
    
    // Insert into general table
    const { data, error } = await supabase
      .from('all_visitors')
      .insert([{ 
        id: userId,
        full_name: fullName, 
        hall_numbers: hallNumbersString,
        registration_time: timestamp
      }]);
    
    dbOperations.push({
      description: "–î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –∑–∞–≥–∞–ª—å–Ω—É —Ç–∞–±–ª–∏—Ü—é",
      table: "all_visitors",
      operation: "insert",
      data: { 
        id: userId,
        full_name: fullName, 
        hall_numbers: hallNumbersString,
        registration_time: timestamp
      },
      response: { data, error }
    });
    
    if (error) throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${error.message}`);
    
    // Add user to each hall (without timestamps)
    const hallOperations = [];
    
    for (const hall of hallNumbersToUse) {
      const { data: hallData, error: hallError } = await supabase
        .from(`hall_${hall}`)
        .insert([{ 
          id: userId,
          full_name: fullName,
          visit_timestamps: []
        }]);
      
      dbOperations.push({
        description: `–î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –∑–∞–ª—É ${hall}`,
        table: `hall_${hall}`,
        operation: "insert",
        data: { 
          id: userId,
          full_name: fullName,
          visit_timestamps: []
        },
        response: { data: hallData, error: hallError }
      });
      
      hallOperations.push({
        hall: hall,
        success: !hallError,
        error: hallError ? hallError.message : null
      });
      
      if (hallError) console.warn(`–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –∑–∞–ª–∏ ${hall}: ${hallError.message}`);
    }
    
    return { userId, data, error, timestamp, hallOperations, dbOperations };
  }
  
  // —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—â–µ–Ω–∏—è –∑–∞–ª–∞
  async function addHallVisit(userId, fullName, hall) {
    const timestamp = new Date().toISOString();
    const dbOperations = [];
    
    try {
      // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–ª–∞
      const { data: userData, error: fetchError } = await supabase
        .from(`hall_${hall}`)
        .select('visit_timestamps')
        .eq('id', userId)
        .single();
      
      dbOperations.push({
        description: `–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –æ –≤—ñ–∑–∏—Ç–∞—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –∑–∞–ª—ñ ${hall}`,
        table: `hall_${hall}`,
        operation: "select",
        data: { id: userId },
        response: { data: userData, error: fetchError }
      });
      
      // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
      if (fetchError) {
        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${fetchError.message}`);
      }
      
      // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
      let timestamps = [];
      
      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
      if (userData && userData.visit_timestamps) {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º —Å –º–∞—Å—Å–∏–≤–æ–º
        timestamps = Array.isArray(userData.visit_timestamps) 
          ? [...userData.visit_timestamps] 
          : [];
      }
      
      // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
      timestamps.push(timestamp);
      
      console.log(`–û–Ω–æ–≤–ª–µ–Ω–Ω—è visit_timestamps –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${fullName} –≤ –∑–∞–ª—ñ ${hall}`);
      console.log(`–ü–æ—Ç–æ—á–Ω—ñ timestamps:`, timestamps);

      console.log("–ü–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:", userData);
console.log("–¢–∏–ø –¥–∞–Ω–∏—Ö visit_timestamps:", typeof userData.visit_timestamps);
console.log("–ó–Ω–∞—á–µ–Ω–Ω—è visit_timestamps:", userData.visit_timestamps);
      
      // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î —Å –Ω–æ–≤—ã–º –º–∞—Å—Å–∏–≤–æ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
      const { data: updateData, error: updateError } = await supabase
        .from(`hall_${hall}`)
        .update({ visit_timestamps: timestamps })
        .eq('id', userId)
        .select();
      
      dbOperations.push({
        description: `–û–Ω–æ–≤–ª–µ–Ω–Ω—è visit_timestamps –≤—ñ–∑—ñ—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –∑–∞–ª—ñ ${hall}`,
        table: `hall_${hall}`,
        operation: "update",
        data: { 
          id: userId, 
          visit_timestamps: timestamps 
        },
        response: { data: updateData, error: updateError }
      });
      
      // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
      if (updateError) {
        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö: ${updateError.message}`);
      }
      
      // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      return {
        success: true,
        data: updateData,
        timestamp,
        isFirstVisit: timestamps.length === 1,
        visitsCount: timestamps.length,
        dbOperations
      };
      
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –≤ addHallVisit:", error);
      
      dbOperations.push({
        description: `–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –≤—ñ–∑–∏—Ç—ñ–≤ –≤ –∑–∞–ª—ñ ${hall}`,
        table: `hall_${hall}`,
        operation: "error",
        data: { error: error.message }
      });
      
      throw error;
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –æ–±—â–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  async function processGeneralRegistration(qrData) {
    const timestamp = new Date().toISOString();
    const debugInfo = {
      mode: 'general',
      parsedData: {},
      dbOperations: [],
      timestamp
    };
    
    try {
      // Parse QR code data
      const { fullName, hallNumbers } = parseQRData(qrData);
      debugInfo.parsedData = { fullName, hallNumbers };
      
      // Check if user exists
      const { exists: userExists, data: userData, error: userCheckError } = await checkUserExists(fullName);
      
      debugInfo.dbOperations.push({
        description: "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞",
        table: "all_visitors",
        operation: "select",
        data: { full_name: fullName },
        response: { exists: userExists, data: userData, error: userCheckError }
      });
      
      if (userCheckError && userCheckError.code !== 'PGRST116') { // Not PGRST116 means real error, not just "not found"
        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${userCheckError.message}`);
      }
      
      // If user doesn't exist, register them
      if (!userExists) {
        const { userId, dbOperations: registerOperations } = await registerNewUser(fullName, hallNumbers);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ registerNewUser –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—Å–∏–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
        debugInfo.dbOperations = [...debugInfo.dbOperations, ...registerOperations];
        
        return { ...debugInfo, isNewRegistration: true };
      } else {
        debugInfo.dbOperations.push({
          description: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω —É —Å–∏—Å—Ç–µ–º—ñ",
          table: "all_visitors",
          operation: "info",
          data: { id: userData.id, full_name: fullName, registration_time: userData.registration_time, hall_numbers: userData.hall_numbers }
        });
        
        return { ...debugInfo, isNewRegistration: false };
      }
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞:", error);
      debugInfo.error = error.message;
      return debugInfo;
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –∑–∞–ª–µ
  async function processHallRegistration(qrData) {
    if (!selectedHall) {
      return {
        mode: 'hall',
        parsedData: { fullName: '', hallNumbers: [] },
        dbOperations: [],
        timestamp: new Date().toISOString(),
        error: "–ù–µ –æ–±—Ä–∞–Ω –∑–∞–ª –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤—ñ–∑–∏—Ç—É"
      };
    }
    
    const timestamp = new Date().toISOString();
    const debugInfo = {
      mode: 'hall',
      parsedData: {},
      dbOperations: [],
      timestamp
    };
    
    try {
      // Parse QR code data
      const { fullName, hallNumbers } = parseQRData(qrData);
      debugInfo.parsedData = { fullName, hallNumbers };
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü–µ
      const { exists: userExists, data: userData, error: userCheckError } = await checkUserExists(fullName);
      
      debugInfo.dbOperations.push({
        description: "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞",
        table: "all_visitors",
        operation: "select",
        data: { full_name: fullName },
        response: { exists: userExists, data: userData, error: userCheckError }
      });
      
      if (userCheckError && userCheckError.code !== 'PGRST116') {
        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${userCheckError.message}`);
      }
      
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
      if (!userExists) {
        throw new Error(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${fullName} –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω —É —Å–∏—Å—Ç–µ–º—ñ`);
      }
      
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –µ–º—É –¥–æ—Å—Ç—É–ø –≤ —ç—Ç–æ—Ç –∑–∞–ª
      if (!isHallAllowed(userData.hall_numbers, selectedHall)) {
        throw new Error(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${fullName} –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω –¥–æ –∑–∞–ª–∏ ${selectedHall}`);
      }
      
      debugInfo.dbOperations.push({
        description: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–π–¥–µ–Ω —É —Å–∏—Å—Ç–µ–º—ñ",
        table: "all_visitors",
        operation: "info",
        data: { id: userData.id, full_name: fullName, registration_time: userData.registration_time, hall_numbers: userData.hall_numbers }
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–ª–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ
      try {
        const { isFirstVisit, visitsCount, timestamp: visitTimestamp, dbOperations: visitOperations } = 
          await addHallVisit(userData.id, fullName, selectedHall);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ addHallVisit –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—Å–∏–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
        debugInfo.dbOperations = [...debugInfo.dbOperations, ...visitOperations];
        
        debugInfo.dbOperations.push({
          description: isFirstVisit 
            ? `–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–µ—Ä—à–∏–π –≤—ñ–∑–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ª–∏ ${selectedHall}` 
            : `–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–∏–π –≤—ñ–∑–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ª–∏ ${selectedHall} (—É—Å—å–æ–≥–æ: ${visitsCount})`,
          table: `hall_${selectedHall}`,
          operation: "info",
          data: { full_name: fullName, visit_time: visitTimestamp, visits_count: visitsCount }
        });
        
        return { ...debugInfo, isFirstVisit, newRegistration: false };
      } catch (visitError) {
        throw visitError;
      }
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞:", error);
      debugInfo.error = error.message;
      return debugInfo;
    }
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  scanButton.addEventListener("click", () => {
    if (registrationMode === 'hall' && !selectedHall) {
      showStatusMessage("–û–±–µ—Ä—ñ—Ç—å –∑–∞–ª—É –ø–µ—Ä–µ–¥ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è–º", false);
      return;
    }
    
    if (!registrationMode) {
      showStatusMessage("–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó", false);
      return;
    }
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    const readerElementId = "reader";
    
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode(readerElementId);
    }
    
    html5QrCode.start(
      { facingMode: "environment" },
      config,
      async qrCodeMessage => {
        await html5QrCode.stop();
        resultDiv.innerHTML = `<h3>–°–∫–∞–Ω–æ–≤–∞–Ω–∏–π QR-–∫–æ–¥:</h3><p>${qrCodeMessage}</p>`;
        
        try {
          let debugInfo;
          
          // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º QR-–∫–æ–¥
          if (registrationMode === 'general') {
            debugInfo = await processGeneralRegistration(qrCodeMessage);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—à–∏–±–∫–µ
            if (debugInfo.error) {
              showStatusMessage(`–ü–æ–º–∏–ª–∫–∞: ${debugInfo.error}`, false);
            } else {
              showStatusMessage(
                debugInfo.isNewRegistration 
                  ? `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${debugInfo.parsedData.fullName} —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω` 
                  : `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${debugInfo.parsedData.fullName} –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω —É —Å–∏—Å—Ç–µ–º—ñ`, 
                true
              );
            }
          } else if (registrationMode === 'hall') {
            debugInfo = await processHallRegistration(qrCodeMessage);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—à–∏–±–∫–µ
            if (debugInfo.error) {
              showStatusMessage(`–ü–æ–º–∏–ª–∫–∞: ${debugInfo.error}`, false);
            } else {
              showStatusMessage(
                debugInfo.isFirstVisit 
                  ? `–ü–µ—Ä—à–∏–π –≤—ñ–∑–∏—Ç –∑–∞–ª–∏ ${selectedHall} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º ${debugInfo.parsedData.fullName}` 
                  : `–í—ñ–∑–∏—Ç –∑–∞–ª–∏ ${selectedHall} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º ${debugInfo.parsedData.fullName} —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ`, 
                true
              );
            }
          }
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          displayDebugInfo(debugInfo);
          
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞:", err);
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
          displayDebugInfo({
            mode: registrationMode,
            parsedData: { fullName: '–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É', hallNumbers: [] },
            dbOperations: [],
            timestamp: new Date().toISOString(),
            error: err.message
          });
          
          showStatusMessage(`–ü–æ–º–∏–ª–∫–∞: ${err.message}`, false);
        }
      },
      errorMessage => {
        console.log("–ü–æ–º–∏–ª–∫–∞ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è:", errorMessage);
      }
    ).catch(err => {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —Å–∫–∞–Ω–µ—Ä—É:", err);
      resultDiv.innerHTML = `<h3>–û—à–∏–±–∫–∞</h3><p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä: ${err.message}</p>`;
      showStatusMessage(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä: ${err.message}`, false);
    });
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  initFromURL();
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (–∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
  window.addEventListener('popstate', (event) => {
    if (event.state) {
      if (event.state.mode) {
        setRegistrationMode(event.state.mode);
      }
      if (event.state.hall) {
        selectHall(event.state.hall);
      }
    } else {
      setRegistrationMode(null);
      selectHall(null);
    }
  });
});
</script>
</body>
</html>
